#!/usr/bin/make -f
# -*- makefile -*-
SHELL := /bin/bash
DEB_BUILD_ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)
DEB_BUILD_ARCH_OS := $(shell dpkg-architecture -qDEB_BUILD_ARCH_OS)
DEB_BUILD_ARCH_BITS := $(shell dpkg-architecture -qDEB_BUILD_ARCH_BITS)
GEM_COMMAND := $(shell if [[ $$(which rvm) ]]; then echo "rvm system do gem"; else echo "gem"; fi)

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

%:
	dh $@

override_dh_clean:
	dh_clean --exclude=external/serialport/README.orig
	rm -rf debian/gemcache
	rm -rf debian/john

build: build-arch
build-arch: build_gems build_john

# Build binary gems
build_gems:
	GEM_TMP=$$( mktemp -d ) ; \
	for gem in `ls lib/gemcache/ruby/1.9.1/arch/${DEB_BUILD_ARCH_OS}${DEB_BUILD_ARCH_BITS}`; do \
		IFS='-' read -a gem_split <<< "$$gem" ; \
		VERSION=$${gem_split[-1]} ; \
		GEM_NAME=$${gem/-$${VERSION}/} ; \
		[[ $$VERSION && $$GEM_NAME ]] && HOME=$$GEM_TMP ${GEM_COMMAND} install --quiet --no-user-install --install-dir debian/gemcache --no-rdoc --no-ri -v "$$VERSION" $$GEM_NAME -- --with-cflags=\"-O2 -pipe -march=native -w\" ; \
	done ; \
	HOME=$$GEM_TMP ${GEM_COMMAND} install --quiet --no-user-install --install-dir debian/gemcache --no-rdoc --no-ri -v "0.11.3" pcaprub -- --with-cflags=\"-O2 -pipe -march=native -w\" ; \
	rm -rf $$GEM_TMP ;

# Build John the Ripper Jumbo
build_john:
	mkdir -p debian/john
	tar -C debian/john -xjf data/john/src.tar.bz2
	cd debian/john/src ; \
	if [ "${DEB_BUILD_ARCH}" = "amd64" -o "${DEB_BUILD_ARCH}" = "x86_64" ]; then \
		mkdir ../run && make clean linux-x86-64   && mv ../run ../run.linux.x64.mmx  ; \
	elif [ "${DEB_BUILD_ARCH}" = "i386" -o "${DEB_BUILD_ARCH}" = "i686" ]; then \
		mkdir ../run && make clean linux-x86-mmx  && mv ../run ../run.linux.x86.mmx  ; \
		mkdir ../run && make clean linux-x86-sse2 && mv ../run ../run.linux.x86.sse2 ; \
		mkdir ../run && make clean linux-x86-any  && mv ../run ../run.linux.x86.any  ; \
	fi
	cd debian/john ; \
	for dir in $$(ls -d run*) ; do \
		if [ -d ../../data/john/$${dir} ] ; then \
			cp -n ../../data/john/$${dir}/* $${dir}/ ; \
		fi ; \
	done



override_dh_install:
	dh_install --exclude=armitage --exclude=data/armitage
	# Replace upstream binary gems
	rm -r debian/metasploit-framework/usr/share/metasploit-framework/lib/gemcache/ruby/1.9.1/{arch,arch-old}
	cp -r debian/gemcache/* debian/metasploit-framework/usr/share/metasploit-framework/lib/gemcache/ruby/1.9.1/
	# Replace John the Ripper
	rm debian/metasploit-framework/usr/share/metasploit-framework/data/john/src.tar.bz2
	rm -r debian/metasploit-framework/usr/share/metasploit-framework/data/john/run.*
	if ls debian/john/run.* &> /dev/null ; then \
		cp -r debian/john/run.* debian/metasploit-framework/usr/share/metasploit-framework/data/john/ ; \
	fi
	
	for binary in `ls msf*`; do \
		ln -s ../share/metasploit-framework/$${binary} debian/metasploit-framework/usr/bin/ ; \
	done
	echo "Note: Editing or removing this file may make updating very unstable" > debian/metasploit-framework/usr/share/metasploit-framework/.apt

override_dh_shlibdeps:
	dh_shlibdeps --exclude=/data/ --exclude=/modules/

override_dh_strip:
	dh_strip --exclude=/data/ --exclude=/modules/

# Skip these targets
override_dh_pysupport:
override_dh_perl:
